{% extends 'base.html' %}

{% block conteudo %}

<body class="w-100 bg-dark">
  {% for num in mesa %}
  {% if num.status == 1 %}
    <input type="hidden" id="controleMesa" name="controleMesa" value="{{ num.mesa }}">
  {% endif %}
  {% endfor %}

  <header class="bg-dark text-white fw-bolder fs-3"
    style="margin-top: 15px; margin-bottom: 20px; justify-content: center; display: flex;">Pedidos Abertos</header>

  <div style="display: flex; justify-content: center; margin-bottom: 20px;">
    <button class="btnMostrarMesas btn fs-5 btn-primary" style="font-weight: bolder; color: white;">
      Mostrar Todos
    </button>
  </div>

  {% set mesas_exibidas = [] %}

  
  <div style="display: none; gap: 10px; flex-wrap: wrap; width: 100%; justify-content: center; padding: 10px;"
    id="mesaButtonsContainer">
    {% for pedido in pedidos %}
      {% if pedido.status == 1 and pedido.id_mesa not in mesas_exibidas %}
        <button class="btnAbrirAberto btn fs-5 btn-success" style="font-weight: bolder; color: white;"
          data-id-mesa="{{ pedido.id_mesa }}">
          MESA:
          <span style="color: chartreuse; font-weight: bolder;">
            {% if pedido.mesa < 10 %}
              0{{ pedido.mesa }}
            {% else %}
              {{ pedido.mesa }}
            {% endif %}
          </span>
        </button>
        {% set mesas_exibidas = mesas_exibidas | merge([pedido.id_mesa]) %}
      {% endif %}
    {% endfor %}
  </div>

  <div class="bg-light table-responsive"
    style="width: 97%; margin-top: 20px; justify-content: center; margin: auto; padding: 10px; margin-bottom: 20px;">
    
    {% set mesas_exibidas = [] %}
    {% set cont = 0 %}

    {% for pedido in pedidos %}
      {% if pedido.status == 1 %}
        {% if pedido.id_mesa not in mesas_exibidas %}
          {# RESET DE CONTROLE DE BEBIDAS POR MESA #}
          {% set bebidas_exibidas = [] %}
          {% set chaves_exibidas = [] %}

          <div class="mesaAberta" style="display: none;" data-id-mesa="{{ pedido.id_mesa }}">
            <div style="display: flex; justify-content: space-evenly; align-items: center; padding: 10px;">   

              {% if pedido.mesa < 10 %} 
                <div>
                  <a href="#" class="editar-mesa" data-mesa-atual="{{ url('editarMesa/' ~ pedido.id_mesa) }}"
                    style="color: white; margin-left: 5px; text-decoration: none;">
                    MESA: <span style="color: lime"> 0{{ pedido.mesa }}</span>
                  </a>      
                </div>
              {% else %}
                <div>
                  <a href="#" class="editar-mesa" data-mesa-atual="{{ url('editarMesa/' ~ pedido.id_mesa) }}"
                    style="color: white; margin-left: 5px; text-decoration: none;">
                    MESA: <span style="color: lime">{{ pedido.mesa }}</span>
                  </a>       
                </div>
              {% endif %}

              <div>STATUS: <span style="color: chartreuse;">ABERTA</span></div>

              {% set mostrado = false %}
              {% for valor in total %}
                {% if pedido.id_mesa == valor.id_mesa and not mostrado and valor.status == 1 %}
                  <div>
                    TOTAL: <span style="color: dodgerblue;">${{ valor.total | number_format(2, ',', '.') }}</span>
                  </div>
                  {% set mostrado = true %}
                {% endif %}
              {% endfor %}

              <div>
                √Ås: <span style="color: lightseagreen;">{{ pedido.data_hora | date('H:i') }}</span>
              </div>

              <div>
                <a href="{{ url('adicionarNaMesa/' ~ pedido.mesa) }}" class="btn fs-5 btn-primary"
                  style="font-weight: bolder; color: white; margin-right: 5px;">
                  Adicionar
                </a>
                <a href="#" class="btn fs-5 btn-danger excluir-mesa"
                  data-url="{{ url('excluirMesa/' ~ pedido.id_mesa) }}"
                  style="font-weight: bolder; color: white; margin-left: 5px;">
                  Excluir Mesa
                </a>
              </div>
            </div>
          </div>

          {% set cont = 0 %}
          {% set mesas_exibidas = mesas_exibidas | merge([pedido.id_mesa]) %}
        {% endif %}

        <table class="tablePedido" data-id-mesa="{{ pedido.id_mesa }}"
          style="justify-content: center; margin-bottom: 5px; width: 100%; display: none;">
          <thead>
            <tr>
              <th class="thTableAberto" scope="col">{% if cont == 0 %}LANCHES{% set cont = 1 %}{% endif %}</th>
              <th class="thTableAberto" scope="col" style="padding-left: 5px;">{% if cont == 1 %}VALOR{% set cont = 2 %}{% endif %}</th>
              <th class="thTableAberto" scope="col">{% if cont == 2 %}BEBIDAS{% set cont = 3 %}{% endif %}</th>
              <th class="thTableAberto" scope="col" style="padding-left: 5px;">{% if cont == 3 %}VALOR{% set cont = 4 %}{% endif %}</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td style="font-weight: bolder;">
                {% if pedido.nome_lanche == 'Em escolha...' %}
                  <a href="{{ url('editarLanche/' ~ pedido.id) }}" style="color: gray; font-style: italic; text-decoration: none;">Em escolha...</a> <br>
                {% else %}
                  <a href="{{ url('editarLanche/' ~ pedido.id) }}" style="text-decoration: none; color: inherit;">{{ pedido.nome_lanche }}</a> <br>
                {% endif %}

                {% for add in adicional %}
                  {% if pedido.id_lanche == add.id %}
                    <div style="margin-top: 5px">
                      {% if add.tipo == '+' %}
                        <span style="color: green; font-weight: bolder;">
                          <a href="{{ url('editarAdicional/' ~ add.chave) }}" style="text-decoration: none; color: inherit;">+{{ add.nome_adicional }}</a>
                        </span>        
                      {% elseif add.tipo == '-' %}
                        <span style="color: red; font-weight: bolder;">
                          <a href="{{ url('editarAdicional/' ~ add.chave) }}" style="text-decoration: none; color: inherit;">-{{ add.nome_adicional }}</a>
                        </span>
                      {% endif %}
                    </div>
                  {% endif %}
                {% endfor %}

                {% if pedido.status == 1 %}
                  <a href="{{ url('adicionarAdicional/' ~ pedido.mesa ~ '/' ~ pedido.id_lanche) }}" class="primary">
                    <i class="fa-solid fa-square-plus"></i>
                  </a>
                {% endif %}
              </td>

              <td>
                {% set somaAdicional = 0 %}
                {% for add in adicional %}
                  {% if pedido.id_lanche == add.id and pedido.status == 1 %}
                    {% set somaAdicional = somaAdicional + add.valor_adicional %}
                  {% endif %}
                {% endfor %}

                {% if pedido.valor_lanche != 0 and pedido.status == 1 %}
                  <span style="font-weight: bolder; padding-left: 5px;">
                    {{ (somaAdicional + pedido.valor_lanche) | number_format(2, ',', '.') }}
                  </span>
                {% endif %}
              </td>

              <td style="font-weight: bolder;">
                {% for bebida in bebidas %}
                  {% if bebida.id_mesa == pedido.id_mesa and pedido.status == 1 %}
                    {% if bebida.chave not in bebidas_exibidas %}
                      <a href="{{ url('editarBebida/' ~ bebida.chave) }}" style="text-decoration: none; color: inherit;">
                        {{ bebida.nome_bebida }} {{ bebida.tamanho_bebida }} <br>
                      </a>
                      {% set bebidas_exibidas = bebidas_exibidas | merge([bebida.chave]) %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              </td>

              <td>
                {% for bebida in bebidas %}
                  {% if bebida.id_mesa == pedido.id_mesa and pedido.status == 1 %}
                    {% if bebida.chave not in chaves_exibidas %}
                      <span style="font-weight: bolder; padding-left: 5px;">{{ bebida.valor_bebida | number_format(2, ',', '.') }}</span> <br>
                      {% set chaves_exibidas = chaves_exibidas | merge([bebida.chave]) %}
                    {% endif %}
                  {% endif %}
                {% endfor %}
              </td>
            </tr>
          </tbody>
        </table>
      {% endif %}
    {% endfor %}
  </div>
</body>

<script src="{{ url('/templates/comanda/assets/js/pedidosAbertos.js') }}" defer></script>
{% endblock %}